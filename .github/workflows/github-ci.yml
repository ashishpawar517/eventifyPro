# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: GH-Repository-CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    permissions: write-all
    runs-on: ubuntu-latest

steps:
  - name: Generate random number and date
    id: generate_values
    run: |
      echo "TAG_NAME=v1.0.$RANDOM" >> $GITHUB_ENV
      echo "RELEASE_NAME=Release $(date +%Y-%m-%d)" >> $GITHUB_ENV
  - name: Checkout Code
    uses: actions/checkout@v3

  - name: Get Next Semver Version
    id: semver
    uses: ietf-tools/semver-action@v1
    with:
      token: ${{ github.token }}
      branch: main
      noVersionBumpBehavior: warn

  - name: Create Tag
    uses: rickstaa/action-create-tag@v1
    if: ${{ steps.semver.outputs.next != '' }}
    with:
      tag: ${{ steps.semver.outputs.next }}
      tag_exists_error: false
      message: "Automatic tag ${{ steps.semver.outputs.next }}"

  - name: Update CHANGELOG
    id: changelog
    uses: requarks/changelog-action@v1
    if: ${{ steps.semver.outputs.next != '' }}
    with:
      token: ${{ github.token }}
      fromTag: ${{ steps.semver.outputs.next }}
      toTag: ${{ steps.semver.outputs.current }}
      excludeTypes: "chore,ci,docs,style,test,release"

  - name: Create Release
    uses: ncipollo/release-action@v1
    id: release
    if: ${{ steps.semver.outputs.next != '' }}
    with:
      allowUpdates: true
      draft: false
      makeLatest: true
      name: ${{ steps.semver.outputs.next }}
      tag: ${{ steps.semver.outputs.next }}
      body: ${{ steps.changelog.outputs.changes }}
      token: ${{ github.token }}

  - name: Commit CHANGELOG.md
    uses: stefanzweifel/git-auto-commit-action@v4
    if: ${{ steps.semver.outputs.next != '' }}
    with:
      branch: ${{ github.head_ref }}
      commit_message: "release: changelog for ${{ steps.semver.outputs.next }} [skip ci]"
      file_pattern: CHANGELOG.md
